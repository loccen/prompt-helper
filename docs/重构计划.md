# Prompt-Helper 重构计划

## 一、项目重构背景

Prompt-Helper 插件在初始开发阶段快速实现了核心功能，但随着功能的不断丰富，代码出现了一些可维护性和可扩展性问题。通过代码分析，我们发现了多处"代码气味"，包括重复代码、紧耦合、大型类和职责混乱等问题。为了提高代码质量，方便后续功能扩展和维护，我们决定对代码进行系统性重构。

## 二、代码问题分析

### 1. 重复代码

- `WorkflowProvider.ts` 和 `DevFlowGuideProvider.ts` 文件中存在大量相似代码
- 多处重复的文件读取和解析逻辑
- UI 构建代码在多个组件中重复出现

### 2. 紧耦合

- `DevFlowGuideProvider` 与 `PromptProvider` 和 `WorkflowProvider` 紧密耦合
- 直接依赖具体实现类而非接口，导致难以替换和测试
- 全局状态和跨组件依赖使调试困难

### 3. 单一职责原则违反

- `DevFlowGuideProvider` 类过大，承担多种职责
- `PromptProvider` 既处理数据加载又承担 UI 相关功能
- 缺乏清晰的模块边界和职责划分

### 4. 配置与代码混合

- 角色类别映射硬编码在 `PromptProvider` 中
- 工作流步骤与角色映射直接写在代码里
- 缺乏统一的配置管理机制

### 5. 错误处理不一致

- 有些地方使用 try-catch，有些地方返回错误状态
- 缺少统一的错误处理策略和用户反馈机制
- 错误信息不够明确，不利于问题排查

## 三、重构目标

1. **提高代码可维护性**：通过重构降低复杂度，使代码易于理解和修改
2. **增强可扩展性**：为新功能添加提供清晰的扩展点和接口
3. **改善可测试性**：重构后的代码应易于编写单元测试
4. **优化用户体验**：重构过程中修复已知 bug 并提升性能
5. **完善文档**：为重构后的代码提供完整的文档说明

## 四、重构计划

### 阶段一：架构重构（优先级高）

1. ✅ 定义核心接口和数据模型
   - 创建 `interfaces.ts` 文件定义共用接口
   - 统一化数据模型和状态表示

2. ✅ 实现分层架构
   - 分离数据访问、业务逻辑和表现层
   - 创建服务类处理核心业务逻辑

3. ✅ 引入依赖注入模式
   - 使用构造函数注入依赖
   - 减少对具体实现的依赖

### 阶段二：组件拆分（优先级中）

1. ✅ 拆分 `DevFlowGuideProvider`
   - 将 HTML 生成移至专门的生成器类
   - 创建状态管理类处理流程状态
   - 分离消息处理和视图更新逻辑

2. ✅ 重构 `PromptProvider`
   - 创建专门的 `PromptService` 处理数据访问
   - 将 UI 相关代码移至 `PromptTreeProvider`
   - 分离角色分类逻辑

3. ✅ 重构 `WorkflowProvider`
   - 创建专门的 `WorkflowService` 处理工作流数据
   - 分离 UI 和数据逻辑

### 阶段三：功能优化（优先级中）

1. ✅ 统一错误处理
   - 创建统一的错误处理机制
   - 改善错误提示和用户反馈
   - 实现日志记录机制

2. ✅ 重构配置管理
   - 将角色分类配置移至配置文件
   - 实现配置的动态加载和热更新
   - 支持用户自定义配置

3. ⬜ 优化数据加载
   - 实现数据缓存机制
   - 优化文件读取性能
   - 添加数据验证逻辑

### 阶段四：体验提升（优先级低）

1. ⬜ 界面优化
   - 改进 WebView 响应速度
   - 优化视觉设计和布局
   - 增强用户交互反馈

2. ⬜ 添加进度和加载指示
   - 为长时间操作添加进度指示
   - 实现优雅的加载状态展示

3. ⬜ 改进国际化支持
   - 将界面文本提取到资源文件
   - 支持多语言切换

### 阶段五：测试与文档（持续进行）

1. ⬜ 添加单元测试
   - 为核心服务类编写单元测试
   - 为关键功能添加集成测试
   - 设置自动化测试流程

2. ✅ 完善代码文档
   - 添加类、方法和接口注释
   - 更新项目文档
   - 编写开发指南和贡献指南

3. ✅ 优化代码风格
   - 统一代码格式和命名规范
   - 使用 ESLint 和 Prettier 检查代码风格
   - 消除死代码和不必要的注释

## 五、重构进度

### 已完成工作

1. ✅ 创建和定义核心接口
   - 完成 `interfaces.ts` 文件，包含所有共用接口
   - 定义了统一的数据模型和类型

2. ✅ 实现服务层
   - 开发 `PromptService` 处理提示词数据访问
   - 实现 `WorkflowService` 管理工作流定义
   - 创建 `FlowStepsMappingService` 处理步骤映射

3. ✅ 改进组件结构
   - 拆分 `DevFlowGuideProvider` 为多个职责单一的组件
   - 实现 `FlowStateManager` 管理工作流状态
   - 创建 `DevFlowHtmlGenerator` 生成 WebView HTML

4. ✅ 配置层实现
   - 创建 `config` 目录统一管理配置
   - 实现角色分类配置的加载和管理
   - 提供配置更新机制

5. ✅ 工具函数优化
   - 在 `utils.ts` 中添加通用工具函数
   - 实现统一的错误处理和日志记录
   - 提供公共操作函数

### 进行中工作

1. ⏳ 单元测试开发
   - 正在为核心服务编写测试用例
   - 计划添加关键功能的集成测试

2. ⏳ 文档更新
   - 已更新项目架构文档
   - 正在编写开发指南和代码贡献指南

### 待完成工作

1. ⬜ 性能优化
   - 数据加载优化
   - 渲染性能改进
   - 内存使用优化

2. ⬜ 用户体验优化
   - 界面响应性提升
   - 错误反馈机制完善
   - 加载状态优化

3. ⬜ 扩展机制
   - 实现插件扩展点
   - 支持自定义提示词模板
   - 添加工作流自定义机制

## 六、风险评估

### 潜在风险

1. **功能回归**：重构可能导致现有功能失效或行为变化
   - 缓解措施：增加测试覆盖率，实施渐进式重构

2. **性能影响**：分层架构可能引入额外开销
   - 缓解措施：性能测试，针对关键路径优化

3. **开发延迟**：重构可能占用新功能开发时间
   - 缓解措施：明确优先级，分阶段进行重构

### 应对策略

1. **渐进式重构**：每次只重构一小部分，确保功能正常
2. **持续集成**：使用自动化测试验证重构成果
3. **边界保护**：保持外部API稳定，内部实现可自由变化

## 七、后续工作

完成重构后，我们计划进行以下工作：

1. **功能扩展**
   - 增加提示词模板支持
   - 添加更多类型的工作流
   - 支持多AI助手集成

2. **生态建设**
   - 建立提示词共享机制
   - 实现团队协作功能
   - 推动社区贡献

3. **持续改进**
   - 基于用户反馈迭代优化
   - 定期代码审查和优化
   - 持续添加文档和测试 