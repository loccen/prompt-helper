# Prompt-Helper  项目开发文档

## 项目概述

Prompt-Helper  是一款面向 Cursor 编辑器的扩展插件，旨在通过预置角色提示词和开发流程引导，帮助开发者更高效地完成项目开发。插件主要功能包括：

1. **角色提示词管理**：提供多种开发角色（产品经理、架构师、开发工程师等）的专业提示词，便于快速插入到聊天窗口
2. **项目开发流程**：支持多种预定义的开发流程（如标准项目、前端项目、VSCode插件开发等）
3. **流程引导器**：提供可视化界面，引导用户完成从需求分析到实现的全流程开发

本插件通过预设专业角色提示词模板和开发流程，结合AI助手的能力，帮助开发者更高效地进行项目开发。

## 项目架构

经过重构，Prompt-Helper 插件采用了分层架构设计，各层职责如下：

```
src/
├── config/               # 配置相关模块
│   ├── categories.ts     # 角色分类配置
│   └── index.ts          # 配置模块入口
├── interfaces.ts         # 共用接口定义
├── services/             # 服务层，负责数据访问和处理
│   ├── prompt-service.ts # 提示词服务
│   ├── workflow-service.ts # 工作流服务
│   └── index.ts          # 服务模块入口
├── ui/                   # UI层，负责界面展示
│   ├── tree-view/        # 树视图组件
│   │   ├── prompt-tree-provider.ts  # 提示词树视图提供者
│   │   ├── workflow-tree-provider.ts # 工作流树视图提供者
│   │   └── index.ts      # 树视图模块入口
│   ├── webview/          # WebView组件
│   │   ├── dev-flow-guide-provider.ts # 开发流程引导器
│   │   ├── dev-flow-html-generator.ts # HTML生成器
│   │   ├── flow-state-manager.ts     # 流程状态管理器
│   │   ├── flow-steps-mapping-service.ts # 步骤映射服务
│   │   └── index.ts      # WebView模块入口
│   └── index.ts          # UI模块入口
├── tests/                # 测试模块
├── utils.ts              # 共用工具函数
└── extension.ts          # 插件入口点
```

### 各层职责

1. **接口层**（interfaces.ts）：
   - 定义各组件间通信的接口
   - 提供基础类和类型定义

2. **配置层**（config/）：
   - 管理全局配置信息
   - 提供配置相关的工具函数

3. **服务层**（services/）：
   - 负责数据的加载、处理和管理
   - 提供业务逻辑和数据访问功能

4. **UI层**（ui/）：
   - 负责用户界面展示和交互
   - 包含树视图和WebView组件

5. **工具层**（utils.ts）：
   - 提供通用工具函数
   - 处理日志记录和错误处理

## 核心模块说明

### 1. 服务层组件

#### PromptService

角色提示词服务，负责加载和管理角色提示词数据。

```typescript
// 主要接口
interface PromptService {
  getRoles(): IPromptRole[];                          // 获取所有角色
  getCategories(): string[];                          // 获取所有分类
  getRoleById(roleId: string): IPromptRole | undefined; // 根据ID获取角色
  getRolesByCategory(category: string): IPromptRole[]; // 根据分类获取角色
  getPromptContent(roleId: string): Promise<string | undefined>; // 获取提示词内容
  reload(): void;                                     // 重新加载数据
}
```

#### WorkflowService

工作流服务，负责加载和管理工作流数据。

```typescript
// 主要接口
interface WorkflowService {
  getWorkflows(): IWorkflow[];                        // 获取所有工作流
  getWorkflowById(workflowId: string): IWorkflow | undefined; // 根据ID获取工作流
  reload(): void;                                     // 重新加载数据
}
```

### 2. UI层组件

#### 树视图模块

- `PromptTreeProvider`: 提供角色提示词的树视图数据
- `WorkflowTreeProvider`: 提供工作流的树视图数据

#### WebView模块

- `DevFlowGuideProvider`: 开发流程引导器，协调其他组件
- `FlowStateManager`: 管理流程状态，处理状态持久化
- `DevFlowHtmlGenerator`: 生成WebView界面的HTML内容
- `FlowStepsMappingService`: 管理流程步骤与角色的映射关系

## 核心功能实现细节

### 1. 角色提示词插入功能

当用户点击角色提示词时，插件会：
1. 通过 `promptProvider.getPromptContent()` 获取角色提示词内容
2. 调用 `insertPromptToChat()` 函数，将提示词插入到Cursor的聊天窗口
3. 该函数先将内容复制到剪贴板，然后模拟键盘操作打开聊天窗口并粘贴

### 2. 工作流管理

工作流的核心设计是分步骤进行，每个步骤关联一个特定角色：
1. 在 `workflows.json` 中定义工作流和步骤
2. 每个步骤通过 `role` 属性关联到一个角色提示词
3. 通过 `contextVars` 属性定义该步骤需要从上下文中获取的变量

### 3. 上下文传递机制

为确保流程的连贯性，插件实现了上下文传递机制：
1. 在流程状态 `_flowState` 中维护一个 `projectContext` 对象
2. 当用户完成一个步骤时，将该步骤的输出保存到上下文中
3. 在应用下一个步骤的角色提示词时，根据 `contextVars` 配置，将相关上下文内容追加到提示词后面
4. 追加时采用适当的格式化方式，如：
   ```
   我的项目想法是：XXX
   需求分析结果：XXX
   设计方案：XXX
   ```

### 4. WebView实现

流程引导器使用WebView实现交互界面：
1. 使用HTML、CSS和JavaScript构建界面
2. 通过postMessage与扩展主进程通信
3. 提供直观的步骤导航、进度展示和角色选择功能

## 最近代码修改

最近对代码进行了以下重要修改：

1. **优化按钮布局**：修改了流程引导器中步骤导航按钮的CSS样式，使其在侧边栏宽度调整时保持美观。实现了自动换行和灵活布局，提升了用户界面的适应性。

2. **改进目录形式的输出件支持**：
   - 修改了步骤完成机制，收集输出件目录路径而非纯文本描述
   - 实现了角色与目录的映射关系存储
   - 在后续步骤的角色提示词中自动添加前一步骤的目录引用
   - 修复了角色名称提取逻辑，确保正确去除前缀数字

3. **实现状态持久化功能**：
   - 添加了`_persistFlowState`和`_restoreFlowState`方法
   - 使用VSCode的workspaceState API存储工作流状态
   - 基于工作区路径实现多项目隔离，不同项目状态互不干扰
   - 在所有状态变更点（如步骤切换、步骤完成、上下文更新等）添加持久化调用

4. **增强用户交互体验**：
   - 添加`ignoreFocusOut: true`选项，防止用户切换窗口时输入对话框自动关闭
   - 实现已完成步骤的编辑功能，允许用户修改之前的输出信息
   - 简化输入流程，只保留目录路径输入，减少用户操作步骤

这些改进使得插件更加健壮和用户友好，特别是在处理实际项目开发场景中经常遇到的多文件输出和意外中断情况时。

## 开发环境设置

要继续开发此项目，您需要：

1. **Node.js环境**：确保安装了Node.js和npm
2. **VS Code**：推荐使用VS Code进行扩展开发
3. **TypeScript**：项目使用TypeScript开发
4. **Cursor编辑器**：用于测试插件功能

基本开发流程：
1. 克隆代码库
2. 运行 `npm install` 安装依赖
3. 使用 `npm run compile` 编译代码
4. 按F5启动调试实例

## 下一步开发计划

以下是可能的功能增强方向：

1. **提示词自定义**：增加用户自定义角色提示词的UI界面
2. **工作流自定义**：允许用户通过UI创建和编辑工作流
3. **多语言支持**：增加国际化支持，提供多语言界面
4. **导入/导出功能**：支持提示词和工作流的导入导出
5. **上下文优化**：改进上下文传递机制，支持更复杂的数据结构
6. **AI交互增强**：改进与Cursor AI交互的集成方式

## 常见问题和调试技巧

### 常见问题

1. **角色提示词无法加载**：
   - 检查文件路径和命名是否符合规范
   - 查看控制台日志中的错误信息

2. **提示词无法插入到聊天窗口**：
   - 确保Cursor编辑器已启动
   - 检查utils.ts中的insertPromptToChat函数实现

3. **工作流上下文传递问题**：
   - 检查步骤的contextVars配置是否正确
   - 确认_applyRolePrompt方法中的上下文处理逻辑

### 调试技巧

1. **日志输出**：
   - 使用 `console.log` 在关键点输出日志
   - 通过 "Developer: Toggle Developer Tools" 命令打开开发者工具查看日志

2. **WebView调试**：
   - 在WebView中使用 `console.log` 输出调试信息
   - 这些日志会显示在主开发者工具控制台中

3. **断点调试**：
   - 在VS Code中设置断点进行调试
   - 特别关注上下文数据的流转过程

## 结论

Prompt-Helper  插件通过预设专业角色提示词和开发流程引导，帮助开发者更高效地使用AI辅助编程。本文档提供了插件的详细设计和实现说明，帮助开发者快速理解项目结构并继续开发或维护。

如有任何问题，请参考代码注释或联系项目维护者。

## 开发指南

### 安装依赖

```bash
npm install
```

### 开发环境

1. 打开 VSCode
2. 打开命令面板（Ctrl+Shift+P）
3. 运行 "Developer: Reload Window" 重新加载窗口

### 构建与调试

1. 按 F5 启动调试
2. 修改代码后按 Ctrl+R 重新加载插件

### 代码规范

#### 1. 命名约定

- 接口命名以 `I` 开头，如 `IPromptRole`
- 服务类名以 `Service` 结尾，如 `PromptService`
- 提供者类名以 `Provider` 结尾，如 `PromptTreeProvider`
- 私有成员变量以 `_` 开头，如 `_flowState`

#### 2. 文件组织

- 相关功能放在同一目录下
- 使用 index.ts 导出模块公共 API
- 每个文件职责单一，避免过大的文件

#### 3. 错误处理

- 使用 `handleError` 函数处理错误
- 记录详细的错误信息
- 向用户提供友好的错误提示

### 添加新功能

#### 1. 添加新的提示词角色

1. 在 `prompts/roles` 目录下创建新的角色提示词文件
2. 文件命名格式: `{分类前缀}-{序号}-{角色名称}角色提示词.md`
3. 重新加载插件，新角色将自动显示在列表中

#### 2. 添加新的工作流

1. 编辑 `prompts/workflows.json` 文件
2. 按照现有工作流格式添加新工作流定义
3. 重新加载插件，新工作流将自动显示在列表中

#### 3. 添加新的UI组件

1. 在适当的目录下创建新组件
2. 遵循依赖注入模式，避免直接依赖具体实现
3. 通过服务层访问数据，避免直接操作文件系统
4. 在入口文件中注册和初始化新组件

### 编写测试

#### 1. 单元测试

使用 Mocha 和 assert 编写单元测试：

```typescript
// 示例: flow-state-manager.test.ts
import * as assert from 'assert';
import * as vscode from 'vscode';
import { FlowStateManager } from '../ui/webview/flow-state-manager';

// 创建Mock对象
const mockContext = createMockContext();

// 编写测试用例
suite('FlowStateManager 测试', () => {
  test('应该正确初始化状态', () => {
    const manager = new FlowStateManager(mockContext);
    const state = manager.state;
    
    assert.strictEqual(state.flowId, '');
    // 更多断言...
  });
  
  // 更多测试...
});
```

#### 2. 集成测试

编写集成测试验证组件间的交互：

```typescript
// 示例: workflow-integration.test.ts
suite('工作流集成测试', () => {
  test('工作流启动应正确初始化状态', async () => {
    // 设置测试环境
    const promptService = new PromptService(testPath);
    const workflowService = new WorkflowService(testPath);
    const provider = new WorkflowTreeProvider(workflowService, promptService);
    
    // 执行测试
    await provider.startWorkflow('test-flow', { userIdea: 'Test idea' });
    
    // 验证结果
    // ...
  });
});
```

## 扩展点

### 1. 角色提示词扩展

角色提示词存储在 `prompts/roles` 目录下，格式为 Markdown。可以通过添加新文件扩展角色提示词库。

### 2. 工作流扩展

工作流定义存储在 `prompts/workflows.json` 文件中，可以编辑此文件添加新的工作流。

### 3. UI扩展

可以通过以下方式扩展UI：

- 添加新的树视图提供者
- 添加新的WebView视图
- 增强现有视图的功能

### 4. 服务扩展

可以添加新的服务类处理特定领域的业务逻辑，遵循以下原则：

- 服务类职责单一
- 通过接口定义公共API
- 支持依赖注入

## 故障排除

### 常见问题

1. **插件加载失败**
   - 检查依赖项是否正确安装
   - 查看VSCode开发控制台的错误日志

2. **提示词不显示**
   - 确认提示词文件格式正确
   - 检查文件路径和命名是否符合规范

3. **工作流启动失败**
   - 检查工作流定义是否正确
   - 确认工作流引用的角色提示词存在

### 日志调试

使用 `log` 函数记录调试信息：

```typescript
import { log } from './utils';

// 记录普通日志
log('操作开始');

// 记录并在UI中显示
log('重要信息', true);
```

## 性能优化

### 最佳实践

1. **延迟加载**
   - 不要在启动时加载所有数据
   - 使用按需加载策略

2. **缓存管理**
   - 缓存频繁访问的数据
   - 设置合理的缓存失效策略

3. **异步处理**
   - 使用异步操作避免阻塞UI
   - 提供进度反馈减少用户等待感

## 发布流程

### 准备发布

1. 更新版本号
   - 在 `package.json` 中更新版本号
   - 遵循语义化版本规范

2. 更新变更日志
   - 在 `CHANGELOG.md` 中记录变更
   - 对重要变更提供详细说明

3. 打包插件
   ```bash
   npm run package
   ```

### 发布到市场

1. 登录 Visual Studio Marketplace
2. 上传打包后的 `.vsix` 文件
3. 更新市场元数据和描述 