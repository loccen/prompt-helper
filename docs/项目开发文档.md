# PrompT-Helper 项目开发文档

## 项目概述

PrompT-Helper 是一款面向 Cursor 编辑器的扩展插件，旨在通过预置角色提示词和开发流程引导，帮助开发者更高效地完成项目开发。插件主要功能包括：

1. **角色提示词管理**：提供多种开发角色（产品经理、架构师、开发工程师等）的专业提示词，便于快速插入到聊天窗口
2. **项目开发流程**：支持多种预定义的开发流程（如标准项目、前端项目、VSCode插件开发等）
3. **流程引导器**：提供可视化界面，引导用户完成从需求分析到实现的全流程开发

本插件通过预设专业角色提示词模板和开发流程，结合AI助手的能力，帮助开发者更高效地进行项目开发。

## 目录结构

```
promot-helper/
├── src/                      # 源代码目录
│   ├── extension.ts          # 扩展入口文件
│   ├── promptProvider.ts     # 提示词提供者
│   ├── workflowProvider.ts   # 工作流提供者 
│   ├── workflowProvider.d.ts # 工作流提供者类型定义
│   ├── devFlowGuideProvider.ts # 开发流程引导器
│   └── utils.ts              # 工具函数
├── prompts/                  # 提示词和工作流配置
│   ├── workflows.json        # 工作流定义
│   └── roles/                # 角色提示词目录（包含多种角色的Markdown文件）
├── docs/                     # 文档目录
│   └── 使用指南.md            # 用户使用指南
├── resources/                # 资源文件
├── out/                      # 编译输出目录
├── node_modules/             # 依赖模块
├── package.json              # 项目配置文件
├── tsconfig.json             # TypeScript配置
└── README.md                 # 项目说明文件
```

## 核心组件与数据流

### 1. 主要组件

#### PromptProvider (promptProvider.ts)
- 负责管理和提供角色提示词
- 实现了 TreeDataProvider 接口，提供角色分类和角色列表的树形视图
- 从 prompts/roles/ 目录读取 Markdown 格式的角色提示词文件

#### WorkflowProvider (workflowProvider.ts)
- 管理开发工作流程
- 实现了 TreeDataProvider 接口，提供工作流列表的树形视图
- 从 prompts/workflows.json 文件读取工作流定义

#### DevFlowGuideProvider (devFlowGuideProvider.ts)
- 提供可视化的开发流程引导界面
- 实现了 WebviewViewProvider 接口，使用HTML+CSS+JS构建交互式界面
- 管理开发流程状态，包括当前步骤、上下文数据传递等

#### Utils (utils.ts)
- 提供通用工具函数，如将提示词插入到Cursor聊天窗口

### 2. 数据流

1. **角色提示词流程**：
   - 用户从左侧面板的角色列表中选择角色
   - PromptProvider 从对应的 Markdown 文件读取提示词内容
   - 通过 utils.ts 中的 insertPromptToChat 函数插入到聊天窗口

2. **工作流程引导流程**：
   - 用户选择一个预定义的开发流程（标准项目、前端项目等）
   - 用户输入项目想法
   - DevFlowGuideProvider 创建一个新的流程实例，并显示第一个步骤
   - 用户在每个步骤选择合适的角色，并将提示词应用到聊天窗口
   - 用户与AI交互后，将结果标记为已完成，并可继续下一步骤
   - 系统在流程中保存上下文数据（如需求分析结果、设计方案等）
   - 在后续步骤中，上下文数据会自动追加到角色提示词后面

## 关键文件详解

### package.json

包含插件的基本信息、依赖、激活事件、命令和视图定义。扩展使用TypeScript开发，主要依赖VSCode API。

### src/extension.ts

扩展的入口文件，主要职责：
- 初始化各个Provider（PromptProvider, WorkflowProvider, DevFlowGuideProvider）
- 注册命令（插入提示词、启动工作流、打开流程引导器）
- 注册视图（角色列表、工作流列表、流程引导器）

### src/promptProvider.ts

负责管理角色提示词，主要功能：
- 从文件系统读取角色提示词文件
- 根据文件命名规则，将角色提示词分类
- 提供TreeDataProvider接口，用于显示角色列表

### src/workflowProvider.ts

负责管理工作流程，主要功能：
- 从workflows.json文件读取工作流定义
- 提供TreeDataProvider接口，用于显示工作流列表
- 实现工作流启动功能，包括获取用户输入、应用第一个步骤的提示词

### src/devFlowGuideProvider.ts

提供可视化流程引导界面，这是插件最复杂的部分，主要功能：
- 管理流程状态（当前步骤、已完成步骤、项目上下文数据）
- 生成WebView内容，提供流程导航和角色选择界面
- 处理各种交互事件（切换步骤、应用提示词、标记完成等）
- 管理上下文数据的传递，确保流程的连贯性

### prompts/workflows.json

定义了预置的工作流程，包括：
- 工作流基本信息（ID、名称、描述）
- 工作流步骤列表，每个步骤包含：
  - 步骤ID、名称和描述
  - 关联的角色ID
  - 上下文变量列表（contextVars），用于指定该步骤需要的上下文变量

### prompts/roles/ 目录

包含各种角色的提示词文件，采用Markdown格式。文件命名遵循规范：
`<分类编号>-[子分类编号-]<角色名称>角色提示词.md`

例如：
- `1-产品经理角色提示词.md`
- `6-1-后端开发-Java工程师角色提示词.md`

每个文件通常包含角色描述、职责范围、工作方法、协作关系等结构化内容。

## 核心功能实现细节

### 1. 角色提示词插入功能

当用户点击角色提示词时，插件会：
1. 通过 `promptProvider.getPromptContent()` 获取角色提示词内容
2. 调用 `insertPromptToChat()` 函数，将提示词插入到Cursor的聊天窗口
3. 该函数先将内容复制到剪贴板，然后模拟键盘操作打开聊天窗口并粘贴

### 2. 工作流管理

工作流的核心设计是分步骤进行，每个步骤关联一个特定角色：
1. 在 `workflows.json` 中定义工作流和步骤
2. 每个步骤通过 `role` 属性关联到一个角色提示词
3. 通过 `contextVars` 属性定义该步骤需要从上下文中获取的变量

### 3. 上下文传递机制

为确保流程的连贯性，插件实现了上下文传递机制：
1. 在流程状态 `_flowState` 中维护一个 `projectContext` 对象
2. 当用户完成一个步骤时，将该步骤的输出保存到上下文中
3. 在应用下一个步骤的角色提示词时，根据 `contextVars` 配置，将相关上下文内容追加到提示词后面
4. 追加时采用适当的格式化方式，如：
   ```
   我的项目想法是：XXX
   需求分析结果：XXX
   设计方案：XXX
   ```

### 4. WebView实现

流程引导器使用WebView实现交互界面：
1. 使用HTML、CSS和JavaScript构建界面
2. 通过postMessage与扩展主进程通信
3. 提供直观的步骤导航、进度展示和角色选择功能

## 最近代码修改

最近对代码进行了以下重要修改：

1. **优化提示词管理**：移除了`workflows.json`中各步骤的`prompt`字段，改为使用`contextVars`数组来指定步骤需要的上下文变量，避免提示词重复定义。

2. **改进上下文传递机制**：修改了`_applyRolePrompt`方法，使其能够直接从角色文件读取提示词内容，并根据当前步骤的`contextVars`配置，将相关上下文信息追加到提示词之后，确保上下文信息的正确传递。

3. **增强workflows.json的结构**：调整了工作流定义，使其更加灵活，便于添加新的工作流和步骤。

## 开发环境设置

要继续开发此项目，您需要：

1. **Node.js环境**：确保安装了Node.js和npm
2. **VS Code**：推荐使用VS Code进行扩展开发
3. **TypeScript**：项目使用TypeScript开发
4. **Cursor编辑器**：用于测试插件功能

基本开发流程：
1. 克隆代码库
2. 运行 `npm install` 安装依赖
3. 使用 `npm run compile` 编译代码
4. 按F5启动调试实例

## 下一步开发计划

以下是可能的功能增强方向：

1. **提示词自定义**：增加用户自定义角色提示词的UI界面
2. **工作流自定义**：允许用户通过UI创建和编辑工作流
3. **多语言支持**：增加国际化支持，提供多语言界面
4. **导入/导出功能**：支持提示词和工作流的导入导出
5. **上下文优化**：改进上下文传递机制，支持更复杂的数据结构
6. **AI交互增强**：改进与Cursor AI交互的集成方式

## 常见问题和调试技巧

### 常见问题

1. **角色提示词无法加载**：
   - 检查文件路径和命名是否符合规范
   - 查看控制台日志中的错误信息

2. **提示词无法插入到聊天窗口**：
   - 确保Cursor编辑器已启动
   - 检查utils.ts中的insertPromptToChat函数实现

3. **工作流上下文传递问题**：
   - 检查步骤的contextVars配置是否正确
   - 确认_applyRolePrompt方法中的上下文处理逻辑

### 调试技巧

1. **日志输出**：
   - 使用 `console.log` 在关键点输出日志
   - 通过 "Developer: Toggle Developer Tools" 命令打开开发者工具查看日志

2. **WebView调试**：
   - 在WebView中使用 `console.log` 输出调试信息
   - 这些日志会显示在主开发者工具控制台中

3. **断点调试**：
   - 在VS Code中设置断点进行调试
   - 特别关注上下文数据的流转过程

## 结论

PrompT-Helper 插件通过预设专业角色提示词和开发流程引导，帮助开发者更高效地使用AI辅助编程。本文档提供了插件的详细设计和实现说明，帮助开发者快速理解项目结构并继续开发或维护。

如有任何问题，请参考代码注释或联系项目维护者。 