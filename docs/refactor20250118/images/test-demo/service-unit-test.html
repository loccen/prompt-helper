<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt-Helper 服务层单元测试示例</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .code-block {
            background-color: #f8f8f8;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .code-header {
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            margin: -15px -15px 15px -15px;
            border-top-right-radius: 4px;
            font-weight: bold;
        }
        .annotation {
            background-color: #fffde7;
            border-left: 4px solid #fbc02d;
            padding: 15px;
            margin: 15px 0;
        }
        .annotation-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #f57c00;
        }
        .highlight {
            background-color: #fff9c4;
            padding: 0 3px;
        }
        .flow-diagram {
            margin: 30px 0;
            text-align: center;
        }
        .flow-box {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 5px;
            min-width: 150px;
            text-align: center;
        }
        .flow-arrow {
            display: inline-block;
            vertical-align: middle;
            margin: 0 10px;
            font-size: 20px;
            color: #555;
        }
        .section {
            margin: 40px 0;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .result-table th, .result-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        .result-table th {
            background-color: #f2f2f2;
        }
        .test-result {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .test-pass {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .test-fail {
            background-color: #f2dede;
            color: #a94442;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Prompt-Helper 服务层单元测试示例</h1>

        <div class="section">
            <h2>测试环境准备</h2>
            <p>以下是 PromptService 单元测试的准备过程，展示如何使用 Jest 和测试工具类创建测试环境。</p>

            <div class="flow-diagram">
                <div class="flow-box">创建模拟文件系统</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">初始化 PromptService</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">编写测试用例</div>
                <div class="flow-arrow">→</div>
                <div class="flow-box">运行断言验证</div>
            </div>

            <div class="code-block">
                <div class="code-header">PromptService 测试环境准备</div>
                <pre>
// src/tests/unit/services/prompt-service.test.ts
import * as path from 'path';
import { PromptService } from '../../../services/prompt-service';
import { TestUtils } from '../../utils/test-utils';

describe('PromptService', () => {
  let service: PromptService;
  let mockFs: any;
  let mockPath: string;
  
  beforeEach(() => {
    // 准备测试数据
    mockPath = '/fake/path';
    mockFs = TestUtils.createMockFileSystem({
      '/fake/path/prompts/roles/test-role.md': '# Test Role\n\n## 角色描述\n\nTest description',
      '/fake/path/prompts/roles/another-role.md': '# Another Role\n\n## 角色描述\n\nAnother description'
    });
    
    // 实例化被测服务
    service = new PromptService(mockPath, mockFs);
  });
  
  // 测试用例...
});</pre>
            </div>

            <div class="annotation">
                <div class="annotation-header">测试环境说明</div>
                <p>在 <span class="highlight">beforeEach</span> 中，我们使用 <span class="highlight">TestUtils.createMockFileSystem</span> 创建一个模拟文件系统，这样测试可以在不依赖真实文件系统的情况下运行。通过依赖注入将模拟对象传递给 PromptService，使得服务的行为可预测且可控。</p>
            </div>
        </div>

        <div class="section">
            <h2>单元测试用例</h2>
            <p>以下是 PromptService 的几个关键测试用例，演示如何测试不同的功能点和边界条件。</p>

            <div class="code-block">
                <div class="code-header">加载角色测试</div>
                <pre>
test('should load roles correctly', () => {
  // Act
  const roles = service.getRoles();
  
  // Assert
  expect(roles.length).toBe(2);
  expect(roles[0].name).toBe('Test Role');
  expect(roles[1].name).toBe('Another Role');
});</pre>
            </div>

            <div class="code-block">
                <div class="code-header">获取提示词内容测试</div>
                <pre>
test('should get prompt content', async () => {
  // Act
  const content = await service.getPromptContent('test-role');
  
  // Assert
  expect(content).toContain('Test Role');
  expect(content).toContain('Test description');
});</pre>
            </div>

            <div class="code-block">
                <div class="code-header">错误处理测试</div>
                <pre>
test('should handle missing role', async () => {
  // Act & Assert
  await expect(service.getPromptContent('non-existent')).rejects.toThrow();
});</pre>
            </div>

            <div class="annotation">
                <div class="annotation-header">测试用例说明</div>
                <p>上述测试用例遵循 AAA 模式（Arrange-Act-Assert）：</p>
                <ul>
                    <li><strong>Arrange</strong>: 在 beforeEach 中已经完成了测试环境的准备</li>
                    <li><strong>Act</strong>: 调用被测服务的方法</li>
                    <li><strong>Assert</strong>: 验证方法的返回值或行为是否符合预期</li>
                </ul>
                <p>测试用例覆盖了正常功能和错误处理两种情况，确保服务在各种条件下都能正确工作。</p>
            </div>
        </div>

        <div class="section">
            <h2>测试结果</h2>
            <p>运行测试后，Jest 将生成以下测试结果和覆盖率报告：</p>

            <div class="code-block">
                <div class="code-header">测试执行结果</div>
                <pre>
PASS  src/tests/unit/services/prompt-service.test.ts
  PromptService
    ✓ should load roles correctly (5ms)
    ✓ should get prompt content (2ms)
    ✓ should handle missing role (1ms)

Test Suites: 1 passed, 1 total
Tests:       3 passed, 3 total
Snapshots:   0 total
Time:        2.145s
Ran all test suites related to "prompt-service".</pre>
            </div>

            <div class="code-block">
                <div class="code-header">覆盖率报告</div>
                <pre>
----------------------|---------|----------|---------|---------|-------------------
File                  | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
----------------------|---------|----------|---------|---------|-------------------
All files             |    92.5 |    85.71 |     100 |   94.44 |                   
 services             |    92.5 |    85.71 |     100 |   94.44 |                   
  prompt-service.ts   |    92.5 |    85.71 |     100 |   94.44 | 45                
----------------------|---------|----------|---------|---------|-------------------</pre>
            </div>

            <table class="result-table">
                <thead>
                    <tr>
                        <th>测试用例</th>
                        <th>描述</th>
                        <th>结果</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>角色加载测试</td>
                        <td>验证服务能正确加载角色列表</td>
                        <td><span class="test-result test-pass">通过</span></td>
                    </tr>
                    <tr>
                        <td>提示词内容获取测试</td>
                        <td>验证服务能正确获取角色提示词内容</td>
                        <td><span class="test-result test-pass">通过</span></td>
                    </tr>
                    <tr>
                        <td>错误处理测试</td>
                        <td>验证服务在角色不存在时能正确抛出异常</td>
                        <td><span class="test-result test-pass">通过</span></td>
                    </tr>
                </tbody>
            </table>

            <div class="annotation">
                <div class="annotation-header">测试结果说明</div>
                <p>测试覆盖率结果显示，PromptService 的语句覆盖率达到 92.5%，分支覆盖率达到 85.71%，函数覆盖率达到 100%，已经达到目标覆盖率要求。</p>
                <p>唯一未覆盖的代码行是第 45 行，可能是一些边缘情况处理逻辑。在下一轮测试中，我们可以添加更多测试用例来提高覆盖率。</p>
            </div>
        </div>

        <div class="section">
            <h2>最佳实践总结</h2>
            <ul>
                <li>使用依赖注入模式使组件易于测试</li>
                <li>创建模拟对象隔离外部依赖</li>
                <li>遵循 AAA 模式结构化测试用例</li>
                <li>测试正常流程和异常流程</li>
                <li>使用 Jest 的断言函数验证结果</li>
                <li>监控测试覆盖率并持续改进</li>
            </ul>
        </div>
    </div>
</body>
</html> 