# Prompt-Helper  开发说明

## 项目概述

Prompt-Helper 是一款为Cursor编辑器开发的VSCode插件，旨在帮助开发者通过预置角色提示词快速完成项目开发流程。插件提供了多种开发角色的提示词和预定义的开发流程，用户只需提供一个项目想法，便可通过不同角色分工，一步步完成完整的项目开发。

## 技术架构

插件基于VSCode扩展API开发，主要使用TypeScript语言。核心组件包括：

1. **角色提示词提供者**：负责加载和管理预置的角色提示词
2. **工作流提供者**：负责加载和管理预定义的开发流程
3. **UI组件**：包括侧边栏视图、树视图等
4. **命令处理**：处理插入提示词、启动工作流等命令

## 目录结构

```
prompt-helper/
├── src/                      # 源代码目录
│   ├── extension.ts          # 插件入口文件
│   ├── promptProvider.ts     # 角色提示词提供者
│   ├── workflowProvider.ts   # 工作流提供者
│   └── utils.ts              # 实用工具函数
├── prompts/                  # 提示词和工作流定义
│   ├── roles/                # 角色提示词目录
│   │   ├── product-manager.md    # 产品经理角色提示词
│   │   ├── architect.md          # 系统架构师角色提示词
│   │   ├── developer.md          # 开发工程师角色提示词
│   │   └── vscodeplugin-developer.md  # VSCode插件开发工程师角色提示词
│   └── workflows.json        # 工作流定义文件
├── resources/                # 资源文件目录
│   └── icon.svg              # 插件图标
├── docs/                     # 文档目录
│   ├── 使用指南.md            # 用户使用指南
│   ├── 开发说明.md            # 开发说明文档
│   └── images/               # 图片和演示文件
│       └── workflow-demo.html    # 工作流程演示图表
├── package.json              # 插件配置文件
└── tsconfig.json             # TypeScript配置文件
```

## 核心功能实现

### 1. 角色提示词管理

角色提示词以Markdown文件形式存储在`prompts/roles`目录下，通过`PromptProvider`类加载和管理。每个角色提示词文件包含角色描述、技能专长、工作方法等信息。

```typescript
// 加载角色提示词
private loadRoles() {
  try {
    this.roles = [];
    if (fs.existsSync(this.rolesDir)) {
      const files = fs.readdirSync(this.rolesDir).filter(file => file.endsWith('.md'));
      
      for (const file of files) {
        const filePath = path.join(this.rolesDir, file);
        const content = fs.readFileSync(filePath, 'utf-8');
        const titleMatch = content.match(/^# (.+)/m);
        const descriptionMatch = content.match(/## 角色描述\s*\n\s*(.+)/m);
        
        if (titleMatch) {
          const id = path.basename(file, '.md');
          const name = titleMatch[1].replace('角色提示词', '').trim();
          const description = descriptionMatch ? descriptionMatch[1].trim() : '';
          
          this.roles.push({
            id,
            name,
            description,
            filePath
          });
        }
      }
    }
  } catch (error) {
    console.error('加载角色提示词失败:', error);
  }
}
```

### 2. 工作流管理

工作流定义存储在`prompts/workflows.json`文件中，通过`WorkflowProvider`类加载和管理。每个工作流包含多个步骤，每个步骤关联一个角色和提示词模板。

```typescript
// 启动工作流
async startWorkflow(workflowId: string, params: Record<string, string>): Promise<void> {
  const workflow = this.workflows.find(wf => wf.id === workflowId);
  if (!workflow) {
    throw new Error(`找不到工作流: ${workflowId}`);
  }

  // 获取第一个步骤
  const firstStep = workflow.steps[0];
  if (!firstStep) {
    throw new Error(`工作流没有定义步骤: ${workflowId}`);
  }

  // 格式化提示词，替换变量
  let promptContent = firstStep.prompt;
  for (const [key, value] of Object.entries(params)) {
    promptContent = promptContent.replace(new RegExp(`{{${key}}}`, 'g'), value);
  }

  // 插入到聊天窗口
  await insertPromptToChat(promptContent);
}
```

### 3. 目录形式的输出件管理

为支持多文件输出，插件实现了目录输出机制，将每个步骤的输出与对应目录关联起来，并在后续步骤中引用：

```typescript
// 在标记步骤完成时收集目录信息
private async _completeCurrentStep(output: Record<string, any> = {}): Promise<void> {
  // ...
  const outputDirPath = await vscode.window.showInputBox({
    prompt: `请输入此步骤的输出件目录路径（相对于项目根目录）`,
    placeHolder: '例如: docs/产品经理, src/designs 等',
    ignoreFocusOut: true // 防止用户切换窗口时对话框关闭
  });
  
  if (outputDirPath !== undefined) {
    const roleName = this._getRoleNameFromId(currentStep.role);
    
    // 保存目录路径映射
    const existingRoleDirPaths = (this._flowState.projectContext['roleDirPaths'] as Record<string, string>) || {};
    output['roleDirPaths'] = {
      ...existingRoleDirPaths,
      [roleName]: outputDirPath
    };
  }
  // ...
}

// 在应用角色提示词时引用目录信息
private async _applyRolePrompt(roleId: string): Promise<void> {
  // ...
  // 处理前一步骤的输出目录信息
  const roleDirPaths = this._flowState.projectContext['roleDirPaths'] as Record<string, string>;
  if (roleDirPaths && typeof roleDirPaths === 'object') {
    const prevRoleName = this._getRoleNameFromId(prevStep.role);
    const prevRoleDirPath = roleDirPaths[prevRoleName];
    
    if (prevRoleDirPath) {
      contextInfo += `\n\n目录'${prevRoleDirPath}'下的文件为${prevRoleName}给出的输出件，请你作为${currentRoleName}，仔细阅读相关文档，根据这些内容继续你的工作。\n`;
    }
  }
  // ...
}
```

### 4. 状态持久化和多项目支持

插件使用VSCode的workspaceState API实现工作流状态持久化和多项目支持：

```typescript
// 状态持久化
private _persistFlowState(): void {
  try {
    // 获取当前工作区的存储键
    const storageKey = this._getStorageKey();
    
    // 将状态保存到工作区状态存储
    this._context.workspaceState.update(storageKey, this._flowState);
    
    console.log(`已保存流程状态到: ${storageKey}`);
  } catch (error) {
    console.error('保存流程状态失败:', error);
  }
}

// 工作区识别
private _getStorageKey(): string {
  let workspaceId = 'default';
  
  // 获取当前工作区文件夹路径作为唯一ID
  if (vscode.workspace.workspaceFolders && vscode.workspace.workspaceFolders.length > 0) {
    workspaceId = vscode.workspace.workspaceFolders[0].uri.fsPath;
    
    // 对路径进行简单处理避免特殊字符
    workspaceId = workspaceId.replace(/[^a-zA-Z0-9]/g, '_');
  }
  
  return `${this.STORAGE_KEY_PREFIX}.${workspaceId}`;
}

// 状态恢复
private _restoreFlowState(): void {
  try {
    const storageKey = this._getStorageKey();
    const savedState = this._context.workspaceState.get<IFlowState>(storageKey);
    
    if (savedState) {
      console.log(`已恢复流程状态从: ${storageKey}`);
      this._flowState = savedState;
    }
  } catch (error) {
    console.error('恢复流程状态失败:', error);
  }
}
```

## 扩展和自定义

### 添加新角色提示词

1. 在`prompts/roles`目录下创建新的Markdown文件
2. 按照现有角色提示词的格式编写内容
3. 重启插件或刷新视图，新角色将自动加载

### 添加新工作流

1. 编辑`prompts/workflows.json`文件
2. 按照现有工作流的格式添加新的工作流定义
3. 重启插件或刷新视图，新工作流将自动加载

## 构建和发布

### 构建插件

```bash
npm run compile
```

### 打包插件

```bash
npm run vscode:prepublish
```

### 发布到VSCode扩展市场

1. 获取发布者账号和Personal Access Token
2. 使用vsce工具打包和发布插件

```bash
npm install -g vsce
vsce package
vsce publish
```

## 注意事项

1. 插件依赖Cursor编辑器的特定命令和行为，如果Cursor更新可能需要调整相应代码
2. 插入提示词功能使用剪贴板API，可能会临时覆盖用户的剪贴板内容
3. 角色提示词文件需要遵循特定格式，以确保正确解析标题和描述 