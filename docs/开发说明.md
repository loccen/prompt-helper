# PrompT-Helper 开发说明

## 项目概述

PrompT-Helper是一款为Cursor编辑器开发的VSCode插件，旨在帮助开发者通过预置角色提示词快速完成项目开发流程。插件提供了多种开发角色的提示词和预定义的开发流程，用户只需提供一个项目想法，便可通过不同角色分工，一步步完成完整的项目开发。

## 技术架构

插件基于VSCode扩展API开发，主要使用TypeScript语言。核心组件包括：

1. **角色提示词提供者**：负责加载和管理预置的角色提示词
2. **工作流提供者**：负责加载和管理预定义的开发流程
3. **UI组件**：包括侧边栏视图、树视图等
4. **命令处理**：处理插入提示词、启动工作流等命令

## 目录结构

```
prompt-helper/
├── src/                      # 源代码目录
│   ├── extension.ts          # 插件入口文件
│   ├── promptProvider.ts     # 角色提示词提供者
│   ├── workflowProvider.ts   # 工作流提供者
│   └── utils.ts              # 实用工具函数
├── prompts/                  # 提示词和工作流定义
│   ├── roles/                # 角色提示词目录
│   │   ├── product-manager.md    # 产品经理角色提示词
│   │   ├── architect.md          # 系统架构师角色提示词
│   │   ├── developer.md          # 开发工程师角色提示词
│   │   └── vscodeplugin-developer.md  # VSCode插件开发工程师角色提示词
│   └── workflows.json        # 工作流定义文件
├── resources/                # 资源文件目录
│   └── icon.svg              # 插件图标
├── docs/                     # 文档目录
│   ├── 使用指南.md            # 用户使用指南
│   ├── 开发说明.md            # 开发说明文档
│   └── images/               # 图片和演示文件
│       └── workflow-demo.html    # 工作流程演示图表
├── package.json              # 插件配置文件
└── tsconfig.json             # TypeScript配置文件
```

## 核心功能实现

### 1. 角色提示词管理

角色提示词以Markdown文件形式存储在`prompts/roles`目录下，通过`PromptProvider`类加载和管理。每个角色提示词文件包含角色描述、技能专长、工作方法等信息。

```typescript
// 加载角色提示词
private loadRoles() {
  try {
    this.roles = [];
    if (fs.existsSync(this.rolesDir)) {
      const files = fs.readdirSync(this.rolesDir).filter(file => file.endsWith('.md'));
      
      for (const file of files) {
        const filePath = path.join(this.rolesDir, file);
        const content = fs.readFileSync(filePath, 'utf-8');
        const titleMatch = content.match(/^# (.+)/m);
        const descriptionMatch = content.match(/## 角色描述\s*\n\s*(.+)/m);
        
        if (titleMatch) {
          const id = path.basename(file, '.md');
          const name = titleMatch[1].replace('角色提示词', '').trim();
          const description = descriptionMatch ? descriptionMatch[1].trim() : '';
          
          this.roles.push({
            id,
            name,
            description,
            filePath
          });
        }
      }
    }
  } catch (error) {
    console.error('加载角色提示词失败:', error);
  }
}
```

### 2. 工作流管理

工作流定义存储在`prompts/workflows.json`文件中，通过`WorkflowProvider`类加载和管理。每个工作流包含多个步骤，每个步骤关联一个角色和提示词模板。

```typescript
// 启动工作流
async startWorkflow(workflowId: string, params: Record<string, string>): Promise<void> {
  const workflow = this.workflows.find(wf => wf.id === workflowId);
  if (!workflow) {
    throw new Error(`找不到工作流: ${workflowId}`);
  }

  // 获取第一个步骤
  const firstStep = workflow.steps[0];
  if (!firstStep) {
    throw new Error(`工作流没有定义步骤: ${workflowId}`);
  }

  // 格式化提示词，替换变量
  let promptContent = firstStep.prompt;
  for (const [key, value] of Object.entries(params)) {
    promptContent = promptContent.replace(new RegExp(`{{${key}}}`, 'g'), value);
  }

  // 插入到聊天窗口
  await insertPromptToChat(promptContent);
}
```

### 3. 插入提示词到聊天窗口

通过`insertPromptToChat`函数将提示词插入到Cursor的聊天窗口中。由于Cursor基于VSCode，我们使用VSCode的剪贴板API和命令API模拟用户操作。

```typescript
export async function insertPromptToChat(content: string): Promise<void> {
  // 保存当前剪贴板内容
  const originalClipboard = await vscode.env.clipboard.readText();
  
  try {
    // 将提示词内容复制到剪贴板
    await vscode.env.clipboard.writeText(content);
    
    // 尝试通过命令激活聊天面板
    await vscode.commands.executeCommand('cursor.focusChat');
    
    // 等待一小段时间确保聊天面板已激活
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // 模拟粘贴操作
    await vscode.commands.executeCommand('editor.action.clipboardPasteAction');
  } finally {
    // 恢复原始剪贴板内容
    await vscode.env.clipboard.writeText(originalClipboard);
  }
}
```

## 扩展和自定义

### 添加新角色提示词

1. 在`prompts/roles`目录下创建新的Markdown文件
2. 按照现有角色提示词的格式编写内容
3. 重启插件或刷新视图，新角色将自动加载

### 添加新工作流

1. 编辑`prompts/workflows.json`文件
2. 按照现有工作流的格式添加新的工作流定义
3. 重启插件或刷新视图，新工作流将自动加载

## 构建和发布

### 构建插件

```bash
npm run compile
```

### 打包插件

```bash
npm run vscode:prepublish
```

### 发布到VSCode扩展市场

1. 获取发布者账号和Personal Access Token
2. 使用vsce工具打包和发布插件

```bash
npm install -g vsce
vsce package
vsce publish
```

## 注意事项

1. 插件依赖Cursor编辑器的特定命令和行为，如果Cursor更新可能需要调整相应代码
2. 插入提示词功能使用剪贴板API，可能会临时覆盖用户的剪贴板内容
3. 角色提示词文件需要遵循特定格式，以确保正确解析标题和描述 